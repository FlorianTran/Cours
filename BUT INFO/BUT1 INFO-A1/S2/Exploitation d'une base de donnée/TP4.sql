/*TP4*/

drop table communeLA cascade constraints;
drop table distributionLA cascade constraints;
drop table operateurLA cascade constraints;
drop view distributionSmallLA;
drop view nbantenne4g;
drop view nbantenne5g;
drop view nbantennetech;
drop view nbantenneville;
drop view nbantenneville2;

/*EX 0*/

/*1*/
create table communeLA as select * 
    from basetd.commune 
    where code_insee in(select distinct co.code_insee 
        from basetd.commune co,basetd.distribution di,basetd.operateur op 
        where di.code_insee=co.code_insee
        and di.numfo=op.numfo and op.generation='5G' and co.nomdep='Loire-Atantique') and code_insee in  (    
        select distinct co.code_insee 
            from basetd.commune co,basetd.distribution di,basetd.operateur op 
            where di.code_insee=co.code_insee and di.numfo=op.numfo and op.generation='4G' and co.nomdep='Loire-Atlantiqeu');
                
create table operateurLA as select * from basetd.operateur;

create table distributionLA as select di.* 
    from basetd.distribution di,communeLA co, operateurLA op 
    where di.numfo=op.numfo and co.code_insee=di.code_insee;
    
/*2*/
alter table communeLA add constraint pk_co primary key(code_insee);

alter table operateurLA add constraint pk_op primary key(numfo);

alter table distributionLA add constraint pk_di PRIMARY key(id);
alter table distributionLA add CONSTRAINT fk_di1 foreign key(numfo) references operateurLA;
alter table distributionLA add CONSTRAINT fk_di2 foreign key(code_insee) references communeLA;

    
/*EX 1*/  
/*1*/
grant select on communeLA to i2d02a;
grant select on operateurLA to i2d02a;
grant select on distributionLA to i2d02a;
commit;

/*2*/
grant update(adresse) on distributionLA to i2d02a;
commit;

/*3*/
grant insert on distributionLA to i2d02a;
commit;

/*4*/
revoke select on communeLA from i2d02a;
revoke select on operateurLA from i2d02a;
revoke select,insert,update on distributionLA from i2d02a;
commit;

/*5*/
create or replace view distributionSmallLA as select ID,NUMFO,CODE_INSEE,ADRESSE,STATUT from distributionLA;
grant select on distributionSmallLA to i2d02a;
commit;

/*6*/
create or replace view NbAntenne5G as 
        select distinct co.nom_commune, op.nomfo, count(*) nbAntenne5G 
            from communeLA co, operateurLA op, distributionLA di 
            where di.numfo=op.numfo and co.code_insee=di.code_insee and op.generation='5G' 
        group by (co.nom_commune, op.nomfo)
        order by 3 desc;

create or replace view NbAntenne4G as
        select distinct co.nom_commune, op.nomfo, count(*) nbAntenne4G
            from communeLA co, operateurLA op, distributionLA di
            where di.numfo=op.numfo and co.code_insee=di.code_insee and op.generation='4G'
        group by (co.nom_commune,op.nomfo)
        order by 3 desc;

grant SELECT on nbAntenne5G to i2d02a;
grant SELECT on nbAntenne4G to i2d02a;
commit;

/*7*/
create or replace view nbAntenneVille as select distinct co.nom_commune,op.nomfo,
    (select count(*) from distributionLA di where di.numfo=op.numfo and co.code_insee=di.code_insee and op.generation='5G')antenne5G,
    (select count(*) from distributionLA di where di.code_insee=co.code_insee and di.numfo=op.numfo and op.generation='4G')antenne4G
    from operateurLA op,communeLA co order by 1;

grant SELECT on nbAntenneVille to i2d02a;
commit;

/*8*/
create or replace view nbAntenneTech as
    select distinct co.nom_commune, op.numfo, op.technologie,op.nomfo,
    (select count(*) from distributionLA di where di.numfo=op.numfo and co.code_insee=di.code_insee)as nbantenne
    from communeLA co, distributionLA di, operateurLA op;

grant select on nbAntenneTech to i2d02a;
commit;

/*9*/
create or replace view nbAntenneVille2 as
    select distinct c.nom_commune, c.nbAntenne5G, q.nbAntenne4G
        from NbAntenne5G c , NbAntenne4G q
        where q.nomfo='ORANGE' and c.nom_commune=q.nom_commune
    order by 2 desc, 1 FETCH NEXT 20 ROWS ONLY;

grant SELECT on nbAntenneVille2 to i2d02a;
commit;

/*EX 2*/

/*1*/
create role i2d02aMon_Ami ;
set role i2d02aMon_Ami;

/*2*/
grant select on communeLA to i2d02aMon_Ami;
grant select on operateurLA to i2d02aMon_Ami;
grant select on distributionLA to i2d02aMon_Ami;
grant update(adresse) on distributionLA to i2d02aMon_Ami;
grant insert on distributionLA to i2d02aMon_Ami;
commit;


/*3*/
Grant i2d02aMon_Ami to i2d02a;
commit;

/*vérification*/
select * from i2d02a.DistributionLA;
select * from i2d02a.CommuneLA;
select * from i2d02a.OperateurLA;

/*4*/
revoke select on distributionLA from i2d02aMon_Ami;
revoke select on operateurLA from i2d02aMon_Ami;
revoke select on communeLA from i2d02aMon_Ami;

/*5*/
Revoke i2d02aMon_Ami to i2d02a;

/*6*/
create role i2d02aVoir_mes_tables;
set role i2d02aVoir_mes_tables;

grant select on distributionLA to i2d02aVoir_mes_tables;
grant select on communeLA to i2d02aVoir_mes_tables;
grant select on operateurLA to i2d02aVoir_mes_tables;

create role i2d02aUpdate_mes_tables;
set role i2d02aUpdate_mes_tables;
grant update(adresse) on distributionLA to i2d02aUpdate_mes_tables;
grant insert on distributionLA TO i2d02aUpdate_mes_tables;

/*7*/
create i2d02aVoir_Update;
set role i2d02aVoir_Update;

grant i2d02aUpdate_mes_tables to i2d02aVoir_Update;
grant i2d02aVoir_mes_tables to i2d02aVoir_Update;

/*8*/
grant i2d02aVoir_Update to i2d02a;

/*9*/
revoke i2d02aUpdate_mes_tables from  i2d02aVoir_update ;


/*EX 3*/
/*1*/
create table communeLA as
        select *
        from basetd.commune
        where code_insee IN(
                select distinct co.code_insee
                from basetd.commune co, basetd.distribution di, basetd.operateur op
                where di.code_insee=co.code_insee
                    and di.numfo=op.numfo
                    and (op.generation='5G' or op.generation='4G')
                    and co.nomdep='Loire-Atlantique');

create table operateurLA as
        select * from basetd.operateur;
        
alter table operateurLA add constraint PKop primary key(numfo);

create table distributionLA as
        select di.*
        from basetd.distribution di, communeLA co, basetd.operateur op
        where di.numfo=op.numfo 
            and co.code_insee=di.code_insee;

/*2*/
create table communeLA as
        select *
        from basetd.commune
        where code_insee IN(
                select distinct co.code_insee
                from basetd.commune co, basetd.distribution di, basetd.operateur op
                where di.code_insee=co.code_insee
                    and di.numfo=op.numfo
                    and (op.generation='5G' or op.generation=�4G�)
                    and co.nomdep='Vendée');

create table distributionLA as
        select di.*
        from basetd.distribution di, communeLA co, basetd.operateur op
        where di.numfo=op.numfo 
            and co.code_insee=di.code_insee;               

/*3*/
alter table CommuneLA add primary key(code_insee);
alter table distributionLA add primary key(ID);
alter table distributionLA add foreign key(code_insee) references communeLA(code_insee);

grant select on distributionLA to i2d02a with grant option;

/*4*/
alter table distributionLA add foreign key(numfo) references i2d02a.operateurLA(numfo);

/*5*/
create or replace view NbAntenne5G as 
        select distinct co.nom_commune, op.nomfo, count(*) nbAntenne5G 
            from communeLA co, i2d02a.operateurLA op, distributionLA di 
            where di.numfo=op.numfo and co.code_insee=di.code_insee and op.generation='5G' 
        group by (co.nom_commune, op.nomfo)
        order by 3 desc;
create or replace view NbAntenne4G as
        select distinct co.nom_commune, op.nomfo, count(*) nbAntenne4G
            from communeLA co, i2d02a.operateurLA op, distributionLA di
            where di.numfo=op.numfo and co.code_insee=di.code_insee and op.generation='4G'
        group by (co.nom_commune,op.nomfo)
        order by 3 desc;
        
grant select on NbAntenne5G to i2d02a;
grant select on NbAntenne4G to i2d02a;


create or replace view nbAntenneVille as select distinct co.nom_commune,op.nomfo,
    (select count(*) from distributionLA di where di.numfo=op.numfo and co.code_insee=di.code_insee and op.generation='5G')antenne5G,
    (select count(*) from distributionLA di where di.code_insee=co.code_insee and di.numfo=op.numfo and op.generation='4G')antenne4G
    from i2d02a.operateurLA op,communeLA co order by 1;
    
grant select on nbAntenneVille to i2d02a;

create or replace view nbAntenneVille as select distinct co.nom_commune,op.nomfo,
    (select count(*) from distributionLA di where di.numfo=op.numfo and co.code_insee=di.code_insee and op.generation='5G')antenne5G,
    (select count(*) from distributionLA di where di.code_insee=co.code_insee and di.numfo=op.numfo and op.generation='4G')antenne4G
    from i2d02a.operateurLA op,communeLA co order by 1;

grant SELECT on nbAntenneVille to i2d02a;

create or replace view nbAntenneTech as
    select distinct co.nom_commune, op.numfo, op.technologie,op.nomfo,
    (select count(*) from distributionLA di where di.numfo=op.numfo and co.code_insee=di.code_insee)as nbantenne
    from communeLA co, distributionLA di, i2d02a.operateurLA op;

grant select on nbAntenneTech to i2d02a;

